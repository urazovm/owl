var item = $("<%= escape_javascript(render(partial: 'items/edit_form', locals: { item: @item })) %>");
$('#item_<%= @item.id %>').replaceWith(item);

<% if @item.type == Item::TYPES.index(:image) %>

    var formSelector = '#item_<%= @item.id %>_form';

    $('#fileupload').fileupload({
        url: "<%= list_item_path(@item.list, @item) %>",
        method: 'put',
        dataType: 'text',
        autoUpload: false,
        acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i,
        maxFileSize: 1500000,
        // dropZone: $('#dropzone'),
        disableImageResize: /Android(?!.*Chrome)|Opera/.test(window.navigator.userAgent),
        previewMaxWidth: 100,
        previewMaxHeight: 100,
        previewCrop: true
    }).on('fileuploadadd', function (e, data) {
        data.context = $('<div/>').appendTo(formSelector + ' .files');
        $.each(data.files, function (index, file) {
            $('<p/>').appendTo(data.context);
        });
        $(formSelector + ' .submit').data(data);
    }).on('fileuploadprocessalways', function (e, data) {
        var index = data.index,
            file = data.files[index],
            node = $(data.context.children()[index]);
        if (file.preview) {
            node.prepend('<br>').prepend(file.preview);
        }
        if (file.error) {
            node.append('<br>').append($('<span class="text-danger"/>').text(file.error));
        }
    }).on('fileuploadfail', function (e, data) {
        alert('fail');
    }).on('fileuploaddone', function (e, data) {
        eval(data.result);
    }).prop('disabled', !$.support.fileInput).parent().addClass($.support.fileInput ? undefined : 'disabled');

    $(formSelector + ' .submit').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).data().submit();
    });

<% end %>
